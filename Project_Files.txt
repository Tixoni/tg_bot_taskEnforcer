[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\requirements.txt]
[–†–∞–∑–º–µ—Ä: 111 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-01-31 19:51:52.989718]

aiogram==3.17.0
fastapi==0.115.0
uvicorn==0.34.0
pydantic==2.10.0
requests==2.32.3
psycopg[binary]==3.1.18
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\runtime.txt]
[–†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-01-31 17:33:15.106470]

python-3.12
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\web\script.js]
[–†–∞–∑–º–µ—Ä: 12067 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-02-04 16:17:26.380300]

const API_BASE_URL = (() => {
    const m = document.querySelector('meta[name="api-base"]');
    return (m && m.getAttribute("content")) || "";
})();

const tg = window.Telegram?.WebApp;
let currentTab = 'today';
let userId = tg?.initDataUnsafe?.user?.id || 0;
let userName = tg?.initDataUnsafe?.user?.username || "User";

let pressTimer;
let selectedItem = null; // { id, type, title }
let isSaving = false;
let calendarDate = new Date(); // –ú–µ—Å—è—Ü, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ—Ç—Ä–∏–º
let selectedDate = new Date(); // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å

(async function init() {
    tg?.ready();
    tg?.expand();
    tg?.setHeaderColor('#000000');
    try {
        await fetch(`${API_BASE_URL}/api/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tg_id: userId, name: userName })
        });
        refreshData();
    } catch (e) { showMessage("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"); }
})();

function switchTab(tab) {
    currentTab = tab;
    document.getElementById('screen-today').classList.toggle('hidden', tab !== 'today');
    document.getElementById('screen-habits').classList.toggle('hidden', tab !== 'habits');
    document.getElementById('screen-calendar').classList.toggle('hidden', tab !== 'calendar');

    document.getElementById('btn-today').classList.toggle('active', tab === 'today');
    document.getElementById('btn-habits').classList.toggle('active', tab === 'habits');

    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${tab}`).classList.add('active');
    
    if (tab === 'calendar') renderCalendar();
    if (tab === 'today') refreshData();
    refreshData();
}

async function refreshData() {
    try {
        const [tRes, hRes] = await Promise.all([
            fetch(`${API_BASE_URL}/api/tasks/${userId}`),
            fetch(`${API_BASE_URL}/api/habits/${userId}`)
        ]);
        renderLists(await tRes.json(), await hRes.json());
    } catch (e) { console.error(e); }
}

function renderLists(tasks, habits) {
    const active = tasks.filter(t => !t.is_completed);
    const done = tasks.filter(t => t.is_completed);

    document.getElementById('list-active-tasks').innerHTML = active.map(t => createItemHTML(t, 'task')).join('');
    document.getElementById('list-today-habits').innerHTML = habits.map(h => createItemHTML(h, 'habit')).join('');
    document.getElementById('list-completed-tasks').innerHTML = done.map(t => createItemHTML(t, 'task')).join('');
    
    const hFull = document.getElementById('list-all-habits');
    if (hFull) hFull.innerHTML = habits.map(h => createItemHTML(h, 'habit')).join('');
}

function createItemHTML(item, type) {
    const isDone = type === 'task' ? item.is_completed : (item.is_completed_today || item.is_complete_today);
    const checkCls = type === 'task' ? 'checkbox-task' : 'checkbox-habit';
    const clickFn = type === 'task' ? `toggleTask(${item.id})` : `toggleHabit(${item.id})`;

    return `
        <div class="card" 
             ontouchstart="handlePressStart(event, ${item.id}, '${type}', '${item.title.replace(/'/g, "\\'")}')" 
             ontouchend="handlePressEnd()" 
             onmousedown="handlePressStart(event, ${item.id}, '${type}', '${item.title.replace(/'/g, "\\'")}')" 
             onmouseup="handlePressEnd()">
            <input type="checkbox" class="${checkCls}" ${isDone ? 'checked' : ''} onclick="${clickFn}; event.stopPropagation();">
            <span class="flex-1 ${isDone ? 'line-through opacity-40 text-gray-500' : 'font-semibold text-gray-100'}">${item.title}</span>
        </div>`;
}

// LONG PRESS LOGIC
function handlePressStart(e, id, type, title) {
    if (e.target.tagName === 'INPUT') return;
    pressTimer = window.setTimeout(() => {
        selectedItem = { id, type, title };
        openContextModal();
    }, 600);
}

function handlePressEnd() { clearTimeout(pressTimer); }

function openContextModal() {
    document.getElementById('context-modal').style.display = 'flex';
    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("medium");
}

function closeContextModal() { document.getElementById('context-modal').style.display = 'none'; }

function openEditModal() {
    closeContextModal();
    const input = document.getElementById('edit-input');
    input.value = selectedItem.title;
    document.getElementById('edit-modal').style.display = 'flex';
    setTimeout(() => input.focus(), 100);
}

function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }

async function handleUpdate() {
    const val = document.getElementById('edit-input').value.trim();
    if (!val || !selectedItem) return;
    const path = selectedItem.type === 'task' ? `/api/tasks/update/${selectedItem.id}` : `/api/habits/update/${selectedItem.id}`;
    await fetch(`${API_BASE_URL}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: val })
    });
    closeEditModal();
    refreshData();
}

async function confirmDelete() {
    if (!selectedItem) return;
    const path = selectedItem.type === 'task' ? `/api/tasks/${selectedItem.id}` : `/api/habits/${selectedItem.id}`;
    await fetch(`${API_BASE_URL}${path}`, { method: "DELETE" });
    closeContextModal();
    refreshData();
}

// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (openModal, handleSave, toggleTask...) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
function openModal() {
    const m = document.getElementById('input-modal');
    document.getElementById('modal-title').innerText = currentTab === 'today' ? "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞" : "–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞";
    m.style.display = 'flex';
    setTimeout(() => document.getElementById('main-input').focus(), 100);
}

function closeModal() {
    document.getElementById('input-modal').style.display = 'none';
    document.getElementById('main-input').value = '';
}

async function handleSave() {
    const val = document.getElementById('main-input').value.trim();
    if (!val || isSaving) return;
    isSaving = true;

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∫–ª–∞–¥–∫–∞ –ª–∏–±–æ 'today', –ª–∏–±–æ 'calendar'
    const isTask = (currentTab === 'today' || currentTab === 'calendar');
    const path = isTask ? '/api/tasks/add' : '/api/habits/add';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É
    const taskDate = (currentTab === 'calendar') 
        ? selectedDate.toISOString().split('T')[0] 
        : new Date().toISOString().split('T')[0];

    try {
        await fetch(`${API_BASE_URL}${path}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞—Ç—É, —á—Ç–æ–±—ã –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å –≤ –ë–î
            body: JSON.stringify({ 
                user_id: userId, 
                title: val,
                date: taskDate 
            })
        });
        closeModal();
        refreshData();
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
    } finally { 
        isSaving = false; 
    }
}

async function toggleTask(id) {
    await fetch(`${API_BASE_URL}/api/tasks/toggle/${id}`, { method: "POST" });
    tg?.HapticFeedback?.impactOccurred("light");
    refreshData();
}

async function toggleHabit(id) {
    await fetch(`${API_BASE_URL}/api/habits/toggle/${id}`, { method: "POST" });
    tg?.HapticFeedback?.notificationOccurred("success");
    refreshData();
}

function showMessage(msg) {
    const err = document.getElementById('init-error');
    err.innerText = msg;
    err.classList.remove('hidden');
    setTimeout(() => err.classList.add('hidden'), 3000);
}


// --- –õ–û–ì–ò–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø ---

function renderCalendar() {
    const grid = document.getElementById('calendar-grid-days');
    const title = document.getElementById('calendar-month-title');
    grid.innerHTML = '';
    
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    
    // –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞
    title.innerText = new Intl.DateTimeFormat('ru-RU', { month: 'long' }).format(calendarDate);

    const firstDay = new Date(year, month, 1).getDay() || 7;
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö –¥–Ω–µ–π –≤ –Ω–∞—á–∞–ª–µ
    for (let i = 1; i < firstDay; i++) {
        grid.innerHTML += `<div class="aspect-square"></div>`;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º —á–∏—Å–ª–∞
    for (let d = 1; d <= daysInMonth; d++) {
        const isToday = new Date().toDateString() === new Date(year, month, d).toDateString();
        const activeClass = isToday ? 'border border-orange-500 text-orange-500' : 'text-white bg-zinc-900';
        
        grid.innerHTML += `
            <div onclick="selectDay(${d})" class="aspect-square flex items-center justify-center rounded-xl text-sm font-bold active:scale-90 transition ${activeClass}">
                ${d}
            </div>
        `;
    }
}

function selectDay(day) {
    selectedDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), day);
    document.getElementById('calendar-month-view').classList.add('hidden');
    document.getElementById('calendar-week-view').classList.remove('hidden');
    renderWeekView();
}

function backToMonth() {
    document.getElementById('calendar-month-view').classList.remove('hidden');
    document.getElementById('calendar-week-view').classList.add('hidden');
}

function renderWeekView() {
    const strip = document.getElementById('week-strip');
    strip.innerHTML = '';
    
    const start = new Date(selectedDate);
    start.setDate(selectedDate.getDate() - (selectedDate.getDay() || 7) + 1);

    for (let i = 0; i < 7; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const isActive = d.toDateString() === selectedDate.toDateString();
        
        strip.innerHTML += `
            <div onclick="setSpecificDay('${d.toISOString()}')" class="flex flex-col items-center gap-1 p-3 rounded-2xl transition-all ${isActive ? 'bg-orange-500 text-white' : 'bg-zinc-900 text-zinc-500'}">
                <span class="text-[9px] uppercase font-black">${['–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±','–≤—Å'][i]}</span>
                <span class="text-sm font-bold">${d.getDate()}</span>
            </div>
        `;
    }
    fetchCalendarTasks();
}

async function setSpecificDay(dateStr) {
    selectedDate = new Date(dateStr);
    renderWeekView();
}

async function fetchCalendarTasks() {
    const dateStr = selectedDate.toISOString().split('T')[0];
    const res = await fetch(`${API_BASE_URL}/api/tasks/${userId}?date=${dateStr}`);
    const tasks = await res.json();
    const container = document.getElementById('list-calendar-tasks');
    
    container.innerHTML = tasks.length ? '' : '<div class="p-8 text-center text-zinc-600 text-xs uppercase tracking-widest font-bold">–ó–∞–¥–∞—á –Ω–µ—Ç</div>';
    tasks.forEach(t => {
        container.innerHTML += `
            <div class="card border-b border-zinc-800/50 last:border-none">
                <input type="checkbox" ${t.is_completed ? 'checked' : ''} onclick="toggleTask(${t.id})" class="checkbox-task">
                <span class="${t.is_completed ? 'line-through text-zinc-600' : 'text-white'} text-sm">${t.title}</span>
            </div>
        `;
    });
}

function changeCalendarPeriod(offset) {
    calendarDate.setMonth(calendarDate.getMonth() + offset);
    renderCalendar();
}

function setCalendarToToday() {
    calendarDate = new Date();
    selectedDate = new Date();
    renderCalendar();
    if (!document.getElementById('calendar-week-view').classList.contains('hidden')) {
        renderWeekView();
    }
}
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\web\index.html]
[–†–∞–∑–º–µ—Ä: 7540 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-02-04 15:52:30.157264]

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="api-base" content="https://tgbottaskenforcer-production.up.railway.app">
    <title>Task Enforcer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="pb-24">
    <div id="init-error" class="hidden fixed top-4 left-4 right-4 z-50 p-4 rounded-xl bg-red-900 text-white border border-red-700 text-xs"></div>

    <main id="screen-today" class="p-4 space-y-6">
        <h1 class="text-3xl font-bold text-white mb-2">–°–µ–≥–æ–¥–Ω—è</h1>
        
        <section>
            <h2 class="section-title">–ó–∞–¥–∞—á–∏</h2>
            <div class="section-block">
                <div id="list-active-tasks" class="list-section"></div>
            </div>
        </section>

        <section>
            <h2 class="section-title">–ü—Ä–∏–≤—ã—á–∫–∏</h2>
            <div class="section-block">
                <div id="list-today-habits" class="list-section"></div>
            </div>
        </section>

        <section>
            <h2 class="section-title">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</h2>
            <div class="section-block opacity-50">
                <div id="list-completed-tasks" class="list-section"></div>
            </div>
        </section>
    </main>

    <main id="screen-habits" class="hidden p-4 space-y-6">
        <h1 class="text-3xl font-bold text-white mb-2">–ü—Ä–∏–≤—ã—á–∫–∏</h1>
        <div class="section-block">
            <div id="list-all-habits" class="list-section"></div>
        </div>
    </main>

    <button onclick="switchTab('calendar')" id="btn-calendar" class="nav-btn">
        <span class="text-[10px] uppercase tracking-widest font-bold">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
    </button>
    

    <button onclick="openModal()" class="fab">+</button>


    <main id="screen-calendar" class="p-4 space-y-4 hidden">
        <div class="flex justify-between items-center mb-4">
            <h1 id="calendar-month-title" class="text-2xl font-bold text-white uppercase tracking-tighter">–ú–µ—Å—è—Ü</h1>
            <div class="flex gap-2">
                <button onclick="changeCalendarPeriod(-1)" class="w-10 h-10 flex items-center justify-center bg-zinc-800 rounded-xl active:scale-90 transition">‚Üê</button>
                <button onclick="setCalendarToToday()" class="px-4 h-10 bg-zinc-800 rounded-xl text-[10px] font-bold uppercase tracking-widest active:scale-90 transition">–°–µ–≥–æ–¥–Ω—è</button>
                <button onclick="changeCalendarPeriod(1)" class="w-10 h-10 flex items-center justify-center bg-zinc-800 rounded-xl active:scale-90 transition">‚Üí</button>
            </div>
        </div>
    
        <div id="calendar-month-view">
            <div class="grid grid-cols-7 gap-1 text-center mb-2">
                <div class="text-[10px] text-zinc-500 font-bold">–ü–ù</div>
                <div class="text-[10px] text-zinc-500 font-bold">–í–¢</div>
                <div class="text-[10px] text-zinc-500 font-bold">–°–†</div>
                <div class="text-[10px] text-zinc-500 font-bold">–ß–¢</div>
                <div class="text-[10px] text-zinc-500 font-bold">–ü–¢</div>
                <div class="text-[10px] text-zinc-500 font-bold text-orange-500/50">–°–ë</div>
                <div class="text-[10px] text-zinc-500 font-bold text-orange-500/50">–í–°</div>
            </div>
            <div id="calendar-grid-days" class="grid grid-cols-7 gap-1"></div>
        </div>
    
        <div id="calendar-week-view" class="hidden animate-in fade-in duration-300">
            <button onclick="backToMonth()" class="flex items-center gap-2 text-orange-500 text-[10px] font-bold uppercase tracking-widest mb-6 active:opacity-50 transition">
                <span>‚Üê</span> –í–µ—Å—å –º–µ—Å—è—Ü
            </button>
            <div id="week-strip" class="flex justify-between mb-8"></div>
            
            <section>
                <h2 class="section-title">–ó–∞–¥–∞—á–∏ –Ω–∞ –¥–µ–Ω—å</h2>
                <div class="section-block">
                    <div id="list-calendar-tasks" class="list-section"></div>
                </div>
            </section>
        </div>
    </main>

    <div id="input-modal" class="modal-backdrop" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <span id="modal-title" class="font-bold text-xl text-white">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</span>
                <button onclick="closeModal()" class="text-gray-400">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <input type="text" id="main-input" placeholder="..." 
                   class="w-full p-4 bg-[#252525] rounded-2xl border-none outline-none focus:ring-2 focus:ring-orange-500 text-white text-lg">
            <button onclick="handleSave()" class="w-full mt-6 py-4 bg-orange-500 text-white font-bold rounded-2xl active:scale-95 transition text-lg">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>

    <div id="context-modal" class="modal-backdrop" onclick="closeContextModal()">
        <div class="modal-content !pb-10" onclick="event.stopPropagation()">
            <div class="space-y-3">
                <button onclick="openEditModal()" class="w-full py-4 bg-[#252525] text-white font-bold rounded-2xl flex items-center justify-center gap-2">
                    ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ
                </button>
                <button onclick="confirmDelete()" class="w-full py-4 bg-red-600/20 text-red-500 font-bold rounded-2xl flex items-center justify-center gap-2">
                    üóë –£–¥–∞–ª–∏—Ç—å
                </button>
                <button onclick="closeContextModal()" class="w-full py-4 text-gray-400 font-medium">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-backdrop" onclick="closeEditModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="font-bold text-xl text-white mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h2>
            <input type="text" id="edit-input" class="w-full p-4 bg-[#252525] rounded-2xl border-none outline-none text-white text-lg">
            <button onclick="handleUpdate()" class="w-full mt-6 py-4 bg-orange-500 text-white font-bold rounded-2xl active:scale-95 transition">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="switchTab('today')" id="btn-today" class="nav-btn active">
            <span class="text-[10px] uppercase tracking-widest font-bold">–°–µ–≥–æ–¥–Ω—è</span>
        </button>
        <button onclick="switchTab('habits')" id="btn-habits" class="nav-btn">
            <span class="text-[10px] uppercase tracking-widest font-bold">–ü—Ä–∏–≤—ã—á–∫–∞</span>
        </button>
        <button onclick="switchTab('calendar')" id="btn-calendar" class="nav-btn">
            <span class="text-[10px] uppercase tracking-widest font-bold">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
        </button>
    </nav>

    <script src="script.js"></script>
</body>
</html>
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\web\style.css]
[–†–∞–∑–º–µ—Ä: 3773 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-02-04 15:44:31.037424]

:root {
    --orange-main: #f97316;
    --bg-page: #000000;
    --bg-section: #1a1a1a;
    --bg-section-alt: #252525;
    --text-primary: #ffffff;
    --text-muted: #888888;
}

body {
    background-color: var(--bg-page);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    user-select: none;
    -webkit-user-select: none;
}

.section-title {
    font-size: 11px;
    font-weight: 800;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 10px;
    padding-left: 4px;
}

.section-block {
    background-color: var(--bg-section);
    border-radius: 20px;
    overflow: hidden;
}

.card {
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: transform 0.1s ease, background-color 0.2s;
    -webkit-touch-callout: none;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
.card:active {
    background-color: #222;
    transform: scale(0.98);
}

.nav-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 70px;
    display: flex;
    background-color: #121212;
    border-top: 1px solid #222;
    z-index: 40;
}

.nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
}

.nav-btn.active { color: var(--orange-main); }

.fab {
    position: fixed;
    bottom: 90px; right: 20px;
    width: 64px; height: 64px;
    border-radius: 32px;
    background-color: var(--orange-main);
    color: white;
    font-size: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    z-index: 45;
}

.modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 100;
    align-items: flex-end;
}

.modal-content {
    background: #1c1c1c;
    width: 100%;
    padding: 30px 24px 50px 24px;
    border-radius: 30px 30px 0 0;
    animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.checkbox-habit, .checkbox-task {
    appearance: none;
    -webkit-appearance: none;
    width: 26px; height: 26px;
    border: 2px solid #333;
    background: #111;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
}

.checkbox-habit { border-radius: 50%; }
.checkbox-task { border-radius: 8px; }

.checkbox-habit:checked { background: var(--orange-main); border-color: var(--orange-main); }
.checkbox-task:checked { background: #2563eb; border-color: #2563eb; }

.checkbox-habit:checked::after, .checkbox-task:checked::after {
    content: '';
    position: absolute;
    left: 8px; top: 4px;
    width: 6px; height: 11px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.calendar-day {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
}
.calendar-day.today { color: var(--orange-main); font-weight: 800; border: 1px solid var(--orange-main); }
.calendar-day.selected { background-color: var(--orange-main); color: white; }
.calendar-day.other-month { opacity: 0.2; }

.week-day-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border-radius: 15px;
    background: #1a1a1a;
    width: 45px;
}
.week-day-card.active {
    background: var(--orange-main);
}
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\config.py]
[–†–∞–∑–º–µ—Ä: 47 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-01-31 17:18:53.209299]

import os

TOKEN = os.getenv("BOT_TOKEN", "")
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\Copy_Files_POSSIBLE_DANGER_RUN_ONLY_HERE.py]
[–†–∞–∑–º–µ—Ä: 5446 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-01-31 17:28:36.274893]

import os
import sys
import glob
from pathlib import Path
from datetime import datetime

def main():
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if len(sys.argv) > 1:
        root_dir = sys.argv[1]
    else:
        root_dir = os.path.dirname(os.path.abspath(__file__))
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if not os.path.exists(root_dir):
        print(f'–û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è "{root_dir}" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!')
        input('–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...')
        return 1
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ –ø—É—Ç–∏
    root_dir = os.path.abspath(root_dir)
    
    print(f'–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {root_dir}')
    print()
    
    # –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    if os.path.exists('Project_Files.txt'):
        os.remove('Project_Files.txt')
    
    # –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –¥–ª—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
    allowed_extensions = [
        '*.txt', '*.bat', '*.cmd', '*.ps1', '*.js', '*.html', '*.css', 
        '*.py', '*.java', '*.c', '*.cpp', '*.h', '*.cs', '*.php', 
        '*.xml', '*.json', '*.config', '*.ini', '*.md', '*.sql', 
        '*.yml', '*.yaml'
    ]
    
    # –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    exclude_dirs = ['.git', 'node_modules', 'bin', 'obj', 'packages', '.vs', '.idea']
    
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (1 –ú–ë)
    max_size = 1048576
    
    print('–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤...')
    print()
    
    processed_files = 0
    skipped_files = 0
    
    # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤
    for extension in allowed_extensions:
        pattern = os.path.join(root_dir, '**', extension)
        
        for file_path in glob.glob(pattern, recursive=True):
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–∫–ª—é—á–∞–µ–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            skip_file = False
            for exclude_dir in exclude_dirs:
                if exclude_dir in file_path.split(os.sep):
                    skip_file = True
                    break
            
            if skip_file:
                continue
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
            try:
                file_size = os.path.getsize(file_path)
                mod_time = datetime.fromtimestamp(os.path.getmtime(file_path))
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
                if file_size < max_size:
                    print(f'–û–±—Ä–∞–±–æ—Ç–∫–∞: {file_path}')
                    
                    with open('Project_Files.txt', 'a', encoding='utf-8') as result_file:
                        result_file.write(f'[–§–∞–π–ª: {file_path}]\n')
                        result_file.write(f'[–†–∞–∑–º–µ—Ä: {file_size} –±–∞–π—Ç]\n')
                        result_file.write(f'[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: {mod_time}]\n')
                        result_file.write('\n')
                        
                        # –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
                        try:
                            with open(file_path, 'r', encoding='utf-8') as src_file:
                                content = src_file.read()
                                result_file.write(content)
                        except UnicodeDecodeError:
                            # –ü–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏
                            try:
                                with open(file_path, 'r', encoding='cp1251') as src_file:
                                    content = src_file.read()
                                    result_file.write(content)
                            except:
                                result_file.write('[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ - –≤–æ–∑–º–æ–∂–Ω–æ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª]\n')
                        except Exception as e:
                            result_file.write(f'[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {str(e)}]\n')
                        
                        result_file.write('\n')
                        result_file.write('-----\n')
                        result_file.write('\n')
                    
                    processed_files += 1
                else:
                    print(f'–ü—Ä–æ–ø—É—Å–∫ –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞: {file_path} ({file_size} –±–∞–π—Ç)')
                    
                    with open('Project_Files.txt', 'a', encoding='utf-8') as result_file:
                        result_file.write(f'[–§–∞–π–ª: {file_path} - –ü–†–û–ü–£–©–ï–ù (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π: {file_size} –±–∞–π—Ç)]\n')
                    
                    skipped_files += 1
                    
            except Exception as e:
                print(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ {file_path}: {e}')
    
    print()
    print(f'–ì–æ—Ç–æ–≤–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Project_Files.txt')
    print(f'–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {processed_files}, –ø—Ä–æ–ø—É—â–µ–Ω–æ: {skipped_files}')
    print(f'–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {root_dir}')
    
    # –ü–∞—É–∑–∞ –≤ –∫–æ–Ω—Ü–µ
    input('–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...')
    return 0

if __name__ == '__main__':
    sys.exit(main())
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\run.py]
[–†–∞–∑–º–µ—Ä: 6523 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-02-02 13:51:00.815788]

import asyncio
import logging
import os 
import uvicorn
from aiogram import Bot, Dispatcher
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo  # –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º zoneinfo –≤–º–µ—Å—Ç–æ pytz


from app.database import init_db, reset_daily_habits, delete_completed_tasks, update_daily_user_stats, get_pending_notifications, mark_notification_sent
from config import TOKEN
from app.handlers import router
from app.myapi import app 
from datetime import timezone

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞
SERVER_TZ = ZoneInfo("America/Los_Angeles")  # –ü–æ—è—Å —Å–µ—Ä–≤–µ—Ä–∞ (–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è)
USER_TZ = ZoneInfo("Europe/Moscow")          # –ü–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ú–æ—Å–∫–≤–∞)

async def start_bot(bot, dp):
    dp.include_router(router)
    await bot.delete_webhook(drop_pending_updates=True) 
    await dp.start_polling(bot)

async def schedule_daily_reset():
    """–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ 23:58 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏."""
    while True:
        utc_now = datetime.now(timezone.utc)
        moscow_now = utc_now.astimezone(USER_TZ)
        
        # –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è 23:58
        target_time = moscow_now.replace(hour=23, minute=58, second=0, microsecond=0)
        
        if moscow_now >= target_time:
            target_time += timedelta(days=1)
        
        wait_seconds = (target_time - moscow_now).total_seconds()
        logging.info(f"–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ {wait_seconds/3600:.2f} —á–∞—Å–æ–≤")
        await asyncio.sleep(wait_seconds)
        
        try:
            logging.info("–ù–∞—á–∞–ª–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö...")
            # –ü–û–†–Ø–î–û–ö –í–ê–ñ–ï–ù:
            # 1. –°–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ç–µ–∫—É—â–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –¥–µ–ª–∞–º
            update_daily_user_stats()
            
            # 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            reset_daily_habits()
            
            # 3. –£–¥–∞–ª—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            delete_completed_tasks()
            
            logging.info("–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        
        # –°–ø–∏–º –º–∏–Ω—É—Ç—É, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç—É –∂–µ —Å–µ–∫—É–Ω–¥—É
        await asyncio.sleep(60)

async def get_moscow_time():
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏"""
    utc_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
    return utc_now.astimezone(USER_TZ)

async def get_server_time():
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Ä–≤–µ—Ä–∞"""
    utc_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
    return utc_now.astimezone(SERVER_TZ)




async def notification_worker(bot: Bot):
    """–ö–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–∑—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ API Telegram"""
    logging.info("–í–æ—Ä–∫–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω")
    while True:
        try:
            pending = get_pending_notifications()
            for note in pending:
                u_id = note['user_id']
                text = note['message_text']
                f_id = note['file_id']
                m_type = note['media_type']
                
                try:
                    # –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å API Telegram —á–µ—Ä–µ–∑ aiogram
                    if m_type == 'photo':
                        await bot.send_photo(u_id, photo=f_id, caption=text)
                    elif m_type == 'video':
                        await bot.send_video(u_id, video=f_id, caption=text)
                    elif m_type == 'voice':
                        await bot.send_voice(u_id, voice=f_id, caption=text)
                    else:
                        await bot.send_message(u_id, text=text)
                    
                    mark_notification_sent(note['id'])
                    logging.info(f"–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {u_id}")
                except Exception as send_error:
                    logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {u_id}: {send_error}")
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –≤–æ—Ä–∫–µ—Ä–∞: {e}")
            
        await asyncio.sleep(60)






async def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    init_db()
    
    bot = Bot(token=TOKEN)
    dp = Dispatcher()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç –æ—Ç Railway
    port = int(os.environ.get("PORT", 8000))
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
    server_time = await get_server_time()
    moscow_time = await get_moscow_time()
    logging.info(f"–í—Ä–µ–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è): {server_time.strftime('%Y-%m-%d %H:%M:%S %Z')}")
    logging.info(f"–í—Ä–µ–º—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ú–æ—Å–∫–≤–∞): {moscow_time.strftime('%Y-%m-%d %H:%M:%S %Z')}")
    logging.info(f"–†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏: {(moscow_time - server_time).total_seconds()/3600:.1f} —á–∞—Å–æ–≤")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–∞–∫ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    bot_task = asyncio.create_task(start_bot(bot, dp))
    asyncio.create_task(schedule_daily_reset())
    asyncio.create_task(notification_worker(bot))    # –û–¢–ü–†–ê–í–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞
    config = uvicorn.Config(app, host="0.0.0.0", port=port, log_level="info")
    server = uvicorn.Server(config)
    
    logging.info(f"–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    await server.serve()
    await bot_task

if __name__ == "__main__":
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s'
    )
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–í—ã—Ö–æ–¥")
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\app\database.py]
[–†–∞–∑–º–µ—Ä: 11470 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-02-04 15:39:21.069744]

import os
import psycopg
from psycopg.rows import dict_row

DATABASE_URL = os.getenv("DATABASE_URL")

if not DATABASE_URL:
    raise RuntimeError("DATABASE_URL is not set")

if "sslmode" not in DATABASE_URL and "railway" in DATABASE_URL.lower():
    DATABASE_URL += "&sslmode=require" if "?" in DATABASE_URL else "?sslmode=require"

def get_connection():
    return psycopg.connect(
        DATABASE_URL,
        row_factory=dict_row,
        connect_timeout=10,
    )

def init_db():
    with get_connection() as conn:
        with conn.cursor() as cur:
            # USERS
            cur.execute("""
                CREATE TABLE IF NOT EXISTS users (
                    id SERIAL PRIMARY KEY,
                    tg_id BIGINT UNIQUE NOT NULL,
                    username TEXT NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    counttask INTEGER DEFAULT 0,
                    count_habits INTEGER DEFAULT 0,
                    count_complate_task INTEGER DEFAULT 0,
                    ratio_complate_habits INTEGER DEFAULT 0,
                    days_tracked INTEGER DEFAULT 0 
                );
            """)

            # TASKS
            cur.execute("""
                CREATE TABLE IF NOT EXISTS tasks (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    title TEXT NOT NULL,
                    is_completed BOOLEAN DEFAULT FALSE,
                    task_date DATE DEFAULT CURRENT_DATE
                );
            """)

            cur.execute("""
                CREATE INDEX IF NOT EXISTS idx_tasks_user_id
                ON tasks(user_id);
            """)

            # HABITS
            # –¢–∞–±–ª–∏—Ü–∞ –ü–†–ò–í–´–ß–ï–ö (HABITS)
            cur.execute("""
                CREATE TABLE IF NOT EXISTS habits (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    title TEXT NOT NULL,
                    is_complete_today BOOLEAN DEFAULT FALSE,
                    count_complete INTEGER DEFAULT 0,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (user_id) REFERENCES users (tg_id) ON DELETE CASCADE
                );
            """)
            cur.execute("CREATE INDEX IF NOT EXISTS idx_habits_user_id ON habits(user_id);")

            # EVENT
            cur.execute("""
                CREATE TABLE IF NOT EXISTS scheduled_notifications (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    message_text TEXT,
                    file_id TEXT,           -- ID —Ñ–∞–π–ª–∞ –≤ –¢–µ–ª–µ–≥—Ä–∞–º (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ)
                    media_type TEXT,        -- 'photo', 'video', 'voice' –∏–ª–∏ NULL
                    scheduled_time TIMESTAMP NOT NULL,
                    is_sent BOOLEAN DEFAULT FALSE
                );
            """)

# ================= USERS =================

def add_user(tg_id: int, username: str):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO users (tg_id, username)
                VALUES (%s, %s)
                ON CONFLICT (tg_id) DO NOTHING;
            """, (tg_id, username))

# ================= TASKS =================

def add_task(user_id, title, task_date=None):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO tasks (user_id, title, task_date) 
                VALUES (%s, %s, %s)
            """, (user_id, title, task_date or datetime.now().date()))
        conn.commit()
def get_user_tasks(user_id, date_str=None):
    with get_connection() as conn:
        with conn.cursor() as cur:
            if date_str:
                cur.execute("SELECT * FROM tasks WHERE user_id = %s AND task_date = %s ORDER BY id DESC", (user_id, date_str))
            else:
                cur.execute("SELECT * FROM tasks WHERE user_id = %s ORDER BY id DESC", (user_id,))
            return cur.fetchall()

def toggle_task_status(task_id: int):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                UPDATE tasks
                SET is_completed = NOT is_completed
                WHERE id = %s;
            """, (task_id,))


def delete_completed_tasks():
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00)."""
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("DELETE FROM tasks WHERE is_completed = TRUE")
            deleted = cur.rowcount
    return deleted

def delete_task(task_id: int):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("DELETE FROM tasks WHERE id = %s", (task_id,))

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
def update_task_title(task_id: int, new_title: str):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("UPDATE tasks SET title = %s WHERE id = %s", (new_title, task_id))


# ============================ HABITS =================
# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–≤—ã—á–∫–∞–º–∏
def add_habit(user_id: int, title: str):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("INSERT INTO habits (user_id, title) VALUES (%s, %s)", (user_id, title))

def get_user_habits(user_id: int):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("SELECT id, title, is_complete_today FROM habits WHERE user_id = %s", (user_id,))
            return cur.fetchall()

def toggle_habit_status(habit_id: int):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("UPDATE habits SET is_complete_today = NOT is_complete_today WHERE id = %s", (habit_id,))

def delete_habit(habit_id: int):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("DELETE FROM habits WHERE id = %s", (habit_id,))


def update_habit_title(habit_id: int, new_title: str):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("UPDATE habits SET title = %s WHERE id = %s", (new_title, habit_id))


def update_daily_user_stats():
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ 23:58.
    """
    with get_connection() as conn:
        with conn.cursor() as cur:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            cur.execute("SELECT tg_id, days_tracked, ratio_complate_habits FROM users")
            users = cur.fetchall()

            for user in users:
                u_id = user['tg_id']
                days = user['days_tracked']
                old_ratio = user['ratio_complate_habits']

                # 1. –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ (–≤—Å–µ–≥–æ)
                cur.execute("SELECT count(*) as total FROM habits WHERE user_id = %s", (u_id,))
                total_habits = cur.fetchone()['total']

                # 2. –°—á–∏—Ç–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∑–∞ –°–ï–ì–û–î–ù–Ø (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ ratio)
                cur.execute("SELECT count(*) as done FROM habits WHERE user_id = %s AND is_complete_today = TRUE", (u_id,))
                done_habits_today = cur.fetchone()['done']

                # 3. –°—á–∏—Ç–∞–µ–º –í–°–ï –∑–∞–¥–∞—á–∏ (–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ, –∏ –Ω–µ—Ç)
                cur.execute("SELECT count(*) as total_t FROM tasks WHERE user_id = %s", (u_id,))
                total_tasks = cur.fetchone()['total_t']

                # 4. –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á–∏, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –°–ï–ì–û–î–ù–Ø (–∫–æ—Ç–æ—Ä—ã–µ —Å–µ–π—á–∞—Å —É–¥–∞–ª–∏–º)
                cur.execute("SELECT count(*) as done_t FROM tasks WHERE user_id = %s AND is_completed = TRUE", (u_id,))
                done_tasks_today = cur.fetchone()['done_t']

                # –†–∞—Å—á–µ—Ç –≤–∏–Ω—Ä–µ–π—Ç–∞ (ratio_complate_habits)
                # –§–æ—Ä–º—É–ª–∞ —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ: ((–ø—Ä–æ—à–ª—ã–π_% * –¥–Ω–∏) + —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π_%) / (–¥–Ω–∏ + 1)
                today_ratio = (done_habits_today / total_habits * 100) if total_habits > 0 else 0
                new_ratio = int(((old_ratio * days) + today_ratio) / (days + 1))

                # –û–ë–ù–û–í–õ–Ø–ï–ú –í–°–ï –ü–û–õ–Ø
                cur.execute("""
                    UPDATE users 
                    SET 
                        days_tracked = days_tracked + 1,
                        count_habits = %s,
                        counttask = %s,
                        count_complate_task = count_complate_task + %s,
                        ratio_complate_habits = %s
                    WHERE tg_id = %s
                """, (total_habits, total_tasks, done_tasks_today, new_ratio, u_id))
                
        conn.commit()




def reset_daily_habits():
    """
    –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç count_complete –Ω–∞ 1 –¥–ª—è –≤—Å–µ—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∏–≤—ã—á–µ–∫
    –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –º–∞—Ä–∫–µ—Ä is_complete_today –≤ False –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏–≤—ã—á–µ–∫.
    """
    with get_connection() as conn:
        with conn.cursor() as cur:
            # –°–Ω–∞—á–∞–ª–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —É —Ç–µ—Ö, –∫—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª
            cur.execute("""
                UPDATE habits 
                SET count_complete = count_complete + 1 
                WHERE is_complete_today = TRUE;
            """)
            # –ó–∞—Ç–µ–º —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –≤—Å–µ—Ö –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
            cur.execute("UPDATE habits SET is_complete_today = FALSE;")

# ============================ EVENT =================
def add_scheduled_notification(user_id, text, scheduled_time, file_id=None, media_type=None):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO scheduled_notifications (user_id, message_text, scheduled_time, file_id, media_type)
                VALUES (%s, %s, %s, %s, %s)
            """, (user_id, text, scheduled_time, file_id, media_type))
        conn.commit()

def get_pending_notifications():
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ø–æ –ú–æ—Å–∫–≤–µ"""
    with get_connection() as conn:
        with conn.cursor() as cur:
            # –°–¥–≤–∏–≥–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –±–∞–∑—ã –Ω–∞ +3 —á–∞—Å–∞ (–ú–°–ö) –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            cur.execute("""
                SELECT id, user_id, message_text, file_id, media_type 
                FROM scheduled_notifications 
                WHERE is_sent = FALSE 
                AND scheduled_time <= (CURRENT_TIMESTAMP AT TIME ZONE 'UTC' AT TIME ZONE 'Europe/Moscow')
            """)
            return cur.fetchall()

def mark_notification_sent(notif_id):
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("UPDATE scheduled_notifications SET is_sent = TRUE WHERE id = %s", (notif_id,))
        conn.commit()
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\app\handlers.py]
[–†–∞–∑–º–µ—Ä: 1255 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-02-02 13:26:49.453347]

from aiogram import F, Router
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.context import FSMContext


router = Router()

@router.message(Command("start"))
async def cmd_start(message: Message):
    kb = [
        [KeyboardButton(text="/list")],
        [KeyboardButton(text="/add")]
    ]
    keyboard = ReplyKeyboardMarkup(keyboard=kb,resize_keyboard=True)
    await message.answer("–Ø –∑–∞—Å—Ç–∞–≤–ª—é —Ç–µ–±—è —Ä–∞–±–æ—Ç–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∞—è —Å—É—á–∫–∞!", reply_markup=keyboard)


# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü handlers.py
@router.message(F.photo | F.video | F.voice)
async def get_file_id_handler(message: Message):
    if message.photo:
        file_id = message.photo[-1].file_id
        await message.answer(f"ID —Ñ–æ—Ç–æ: `{file_id}`", parse_mode="Markdown")
    elif message.video:
        await message.answer(f"ID –≤–∏–¥–µ–æ: `{message.video.file_id}`", parse_mode="Markdown")
    elif message.voice:
        await message.answer(f"ID –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ: `{message.voice.file_id}`", parse_mode="Markdown")
-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\app\inline.py]
[–†–∞–∑–º–µ—Ä: 0 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-01-28 10:03:18.086374]


-----

[–§–∞–π–ª: c:\Users\Tixon11\obsidian\NewObsidian\–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç\–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π\Programming\aiogram\tg_bot_TaskEnforcer\app\myapi.py]
[–†–∞–∑–º–µ—Ä: 4736 –±–∞–π—Ç]
[–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: 2026-02-04 15:40:56.136106]

from pathlib import Path
from fastapi import FastAPI, HTTPException, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel
from typing import List
import app.database as db
from typing import List, Optional

app = FastAPI()
WEB_DIR = Path(__file__).resolve().parent.parent / "web"

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

class UserRegistration(BaseModel):
    tg_id: int
    name: str

class TaskCreate(BaseModel):
    user_id: int
    title: str
    date: Optional[str] = None

class TaskResponse(BaseModel):
    id: int
    title: str
    is_completed: bool




@app.post("/api/register")
async def register_user(user: UserRegistration):
    try:
        db.add_user(user.tg_id, user.name)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/tasks/add")
async def api_add_task(task: TaskCreate):
    try:
        db.add_task(task.user_id, task.title, task.date)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/tasks/{user_id}")
async def api_get_tasks(user_id: int, date: Optional[str] = None):
    try:
        return db.get_user_tasks(user_id, date)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/tasks/toggle/{task_id}")
async def api_toggle_task(task_id: int):
    try:
        db.toggle_task_status(task_id)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/health")
async def health():
    return {"status": "ok"}


class HabitCreate(BaseModel):
    user_id: int
    title: str

@app.post("/api/habits/add")
async def api_add_habit(habit: HabitCreate):
    db.add_habit(habit.user_id, habit.title)
    return {"status": "ok"}

@app.get("/api/habits/{user_id}")
async def api_get_habits(user_id: int):
    return db.get_user_habits(user_id)

@app.post("/api/habits/toggle/{habit_id}")
async def api_toggle_habit(habit_id: int):
    db.toggle_habit_status(habit_id)
    return {"status": "ok"}



# –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —É–¥–∞–ª–µ–Ω–∏—è
@app.delete("/api/tasks/{task_id}")
async def api_delete_task(task_id: int):
    db.delete_task(task_id)
    return {"status": "ok"}

@app.delete("/api/habits/{habit_id}")
async def api_delete_habit(habit_id: int):
    db.delete_habit(habit_id)
    return {"status": "ok"}

# –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
class UpdateItem(BaseModel):
    title: str

@app.post("/api/tasks/update/{task_id}")
async def api_update_task(task_id: int, data: UpdateItem):
    db.update_task_title(task_id, data.title)
    return {"status": "ok"}

@app.post("/api/habits/update/{habit_id}")
async def api_update_habit(habit_id: int, data: UpdateItem):
    db.update_habit_title(habit_id, data.title)
    return {"status": "ok"}


class HabitResponse(BaseModel):
    id: int
    title: str
    is_complete_today: bool
    count_complete: int

@app.get("/api/habits/{user_id}", response_model=List[HabitResponse])
async def api_get_habits(user_id: int):
    try:
        return db.get_user_habits(user_id)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/habits/toggle/{habit_id}")
async def api_toggle_habit(habit_id: int):
    try:
        db.toggle_habit_status(habit_id)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


# –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
class NotificationSchema(BaseModel):
    user_id: int
    text: Optional[str] = None
    scheduled_time: str  # –§–æ—Ä–º–∞—Ç: "2024-12-31 15:30"
    file_id: Optional[str] = None
    media_type: Optional[str] = None # 'photo', 'video', 'voice'

@app.post("/api/notifications/schedule")
async def schedule_message(data: NotificationSchema):
    try:
        dt = datetime.strptime(data.scheduled_time, "%Y-%m-%d %H:%M")
        db.add_scheduled_notification(
            data.user_id, 
            data.text, 
            dt, 
            data.file_id, 
            data.media_type
        )
        return {"status": "ok", "message": "–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞"}
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))

if WEB_DIR.exists():
    app.mount("/", StaticFiles(directory=str(WEB_DIR), html=True), name="web")
-----

